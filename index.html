<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GEO Mountains In Situ Inventory v3</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
<style>
  body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
  #map { width: 100%; height: 100vh; }
  .map-controls {
    position: absolute; top: 10px; right: 10px;
    background: white; padding: 15px; border-radius: 5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; max-width: 300px;
    font-size: 13px;
  }
  .control-group { margin-bottom: 15px; }
  label { display: block; font-weight: bold; margin-bottom: 5px; }
  select, input[type="checkbox"] { margin-bottom: 5px; }
  select { width: 100%; padding: 5px; }
  .layer-toggle { display: flex; align-items: center; margin-bottom: 8px; }
  .layer-toggle input { margin-right: 8px; }
  #info {
  position: absolute;
  bottom: 10px;
  left: 10px;
  background: rgba(255,255,255,0.95);
  padding: 10px;
  border-radius: 5px;
  max-width: 300px;
  font-size: 12px;

  /* NEW */
  word-break: break-word;      /* wrap long words/URLs */
  overflow-wrap: anywhere;     /* ensure wrapping */
  max-height: 400px;           /* optional: limit popup height */
  overflow-y: auto;            /* scroll if content is taller than max-height */
}

.map-controls select {
  font-size: 13px;   /* 👈 smaller text inside dropdowns */
}

#logo {
  position: absolute;
  bottom: 30px; /* above attribution */
  right: 10px;
  z-index: 1000;
  width: 160px; /* slightly bigger */
  background: white; /* white background */
  border-radius: 5px; /* same rounded corners */
  padding: 5px; /* some padding inside */
  box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* optional subtle shadow */
  pointer-events: none; /* allow clicks to pass through */
}
  }
</style>
</head>
<body>

<div id="map"></div>

<div class="map-controls">
  <div class="control-group">
    <label for="layer-select">GEO Mountains In Situ Inventory v3:</label>
    <select id="layer-select">
      <option value="">Select SUB-LAYER(S) (Network / Compilation)...</option>
      <option value="SELECT_ALL">SELECT ALL</option>
      <option value="HIDE_ALL">HIDE ALL</option>
    </select>
  </div>
  <div class="control-group">
    <label>Base Layers:</label>
    <div class="layer-toggle">
      <input type="checkbox" id="toggle-gmba" checked>
      <label for="toggle-gmba">Mountain Ranges (GMBA v2)</label>
    </div>
  <div class="layer-toggle">
      <input type="checkbox" id="toggle-countries" checked>
      <label for="toggle-countries">Countries</label>
    </div>
  </div>
  <div class="control-group">
    <label>Base Map:</label>
    <select id="basemap-select">
      <option value="osm">OpenStreetMap</option>
      <option value="satellite">Satellite</option>
    </select>
  </div>
</div>

<div id="info">Click on features to see attributes</div>

<script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

  // Helper to generate a random color
  const randomColor = () => '#' + Math.floor(Math.random()*16777215).toString(16);

// Define world extent in Web Mercator
const worldExtent = ol.proj.transformExtent([-195, -85, 195, 85], 'EPSG:4326', 'EPSG:3857');

const map = new ol.Map({
  target: 'map',
  view: new ol.View({
    center: ol.proj.fromLonLat([10, 11]),  // 10°E, 11°N
    zoom: 2,
    minZoom: 2,
    maxZoom: 14,
    extent: worldExtent  // restrict panning
  })
});
  // Base layers
  const osmLayer = new ol.layer.Tile({ source: new ol.source.OSM() });
  const satelliteLayer = new ol.layer.Tile({
  source: new ol.source.XYZ({
    url: 'https://tiles.maps.eox.at/wmts/1.0.0/s2cloudless-2024_3857/default/g/{z}/{y}/{x}.jpg',
    maxZoom: 18,
    attributions: '&copy; <a href="https://eox.at/">EOX</a> Sentinel-2'
  }),
  visible: false
});

  map.addLayer(osmLayer);
  map.addLayer(satelliteLayer);

  // Countries and GMBA layers
  const countriesLayer = new ol.layer.Vector({
  source: new ol.source.Vector({ url:'countries_simplified.geojson', format:new ol.format.GeoJSON() }),
  style: new ol.style.Style({ stroke:new ol.style.Stroke({color:'#ffffff', width:2}), fill:new ol.style.Fill({color:'rgba(200,200,200,0.1)'}) })
});
const gmbaLayer = new ol.layer.Vector({
  source: new ol.source.Vector({ url:'gmba_v2_simplified.geojson', format:new ol.format.GeoJSON() }),
  style: new ol.style.Style({ stroke:new ol.style.Stroke({color:'#008B7A', width:2}), fill:new ol.style.Fill({color:'rgba(0,139,122,0.1)'}) })
});
  map.addLayer(countriesLayer);
  map.addLayer(gmbaLayer);

  // Mountain layers - track loaded and visible layers
const mountainLayers = {}; // store all loaded layers
const visibleLayers = new Set(); // track which layers are currently visible

const createMountainLayer = (layerName) => {
  if(mountainLayers[layerName]) {
    // Layer already exists, toggle visibility
    const layer = mountainLayers[layerName];
    const isVisible = layer.getVisible();
    layer.setVisible(!isVisible);
    
    if (!isVisible) {
      visibleLayers.add(layerName);
    } else {
      visibleLayers.delete(layerName);
    }
    updateDropdownOptions();
    return;
  }

  // Create new layer
  const vectorSource = new ol.source.Vector({
    url: `${layerName}.geojson`,
    format: new ol.format.GeoJSON()
  });

  const color = randomColor();
  const layer = new ol.layer.Vector({
    source: vectorSource,
    style: new ol.style.Style({
      image: new ol.style.Circle({ radius: 4, fill: new ol.style.Fill({ color }), stroke: new ol.style.Stroke({ color:'#fff', width:1 }) })
    })
  });

  mountainLayers[layerName] = layer;
  visibleLayers.add(layerName);
  map.addLayer(layer);
  updateDropdownOptions();
  console.log('Added layer:', layerName);
};

const selectAllLayers = () => {
  layerNames.forEach(layerName => {
    if (!visibleLayers.has(layerName)) {
      // Layer is not visible, so create/show it
      if (mountainLayers[layerName]) {
        // Layer exists but is hidden
        mountainLayers[layerName].setVisible(true);
        visibleLayers.add(layerName);
      } else {
        // Layer doesn't exist, create it (but don't call updateDropdownOptions inside)
        const vectorSource = new ol.source.Vector({
          url: `${layerName}.geojson`,
          format: new ol.format.GeoJSON()
        });

        const color = randomColor();
        const layer = new ol.layer.Vector({
          source: vectorSource,
          style: new ol.style.Style({
            image: new ol.style.Circle({ radius: 4, fill: new ol.style.Fill({ color }), stroke: new ol.style.Stroke({ color:'#fff', width:1 }) })
          })
        });

        mountainLayers[layerName] = layer;
        visibleLayers.add(layerName);
        map.addLayer(layer);
      }
    }
  });
  updateDropdownOptions();
  console.log('Selected all layers');
};

const hideAllLayers = () => {
  visibleLayers.forEach(layerName => {
    if (mountainLayers[layerName]) {
      mountainLayers[layerName].setVisible(false);
    }
  });
  visibleLayers.clear();
  updateDropdownOptions();
  console.log('Hidden all layers');
};

  // Dropdown
  const layerNames = [
    'ACTRIS','African_Mountain_Research_Foundation','Alpine_Convention_Air_Quality','Ausangate','BMKG_Indonesia',
    'CAMELS_AUS','CAMELS_BR','CAMELS_CH','CAMELS_CL','CAMELS_DE','CAMELS_ES','CAMELS_GB','CAMELS_IND','CAMELS_SE',
    'CAMELS_FR','CAMON','CA_Discharge','CH_Q_Private_and_Cantonal','CODOS','COSMOS_Europe','Canada_Climate',
    'Canada_Hydrometric','Central_Sierra_Snow_Laboratory','China_High_Elevation_Stations','DEIMS_SDR','DHM_Nepal',
    'DMC_Chile','EEAR_Clim','EUROPAREGION_EUREGIO','Ethiopian_Meteorological_Institute','GAW','GHCNd','GHCNh',
    'GLORIA_Andes','GLORIA_Great_Basin','GRDC','GWF_Observatories','Heihe_River_Basin',
    'Hemp_and_Hemp_2024_Tanzania_Precipitation','IANIGLA','ICOS','IDEAM_Colombia','IMIS_CH','INARCH','JALPS',
    'JMA_Japan','Kaligandaki','Kenya_Kimutai_Data_Rescue','Lake_OHara','Langtang','MIREN','MPRC','Mammoth_Mountain',
    'Mount_Lebanon','Mount_Mansfield','Moussala','Mt_Blanc','Mt_Fuji','Mt_Washington','NEON','NEON_Plots','NIWA_New_Zealand',
    'National_Geographic_Everest','NevCAN','Niwot_Ridge','OSCAR_Surface','Other_USA','PMD_Pakistan','PatagoniaMet',
    'Pepin_Kilimanjaro','Peru_Glaciers','Poleka_Kasue','Pyramid','Red_de_Bosques_Andinos','S2S','SCAN','SENAMHI_Peru',
    'SLF_Manual','SNOTEL','SNOTEL_Transitional','SNOW','SNOWCOP','Sagehen_Creek','Samways_et_al_2024','Skalnate_Pleso',
    'SoilTemp','TAHMO','TORP','Tibet_Grasslands_Carbon','Tibet_Soil_Moisture','Tibetan_Plateau_Permafrost',
    'Tuolumne_and_Merced','UCNRS','USGS','Upper_Susitna','VAO','WGMS_In_Situ_Mass_Balance','Wasatch','White_Mountain','Wolverton'
  ];

  const layerSelect = document.getElementById('layer-select');
  layerNames.forEach(name => {
    const option = document.createElement('option');
    option.value = name;
    option.textContent = name.replace(/_/g, ' ');
    layerSelect.appendChild(option);
  });

const updateDropdownOptions = () => {
  const layerSelect = document.getElementById('layer-select');
  // Clear existing options except the first three (default, Select All, Hide All)
  while (layerSelect.children.length > 3) {
    layerSelect.removeChild(layerSelect.lastChild);
  }
  
  // Re-add all layer options with tick marks for visible layers
  layerNames.forEach(name => {
    const option = document.createElement('option');
    option.value = name;
    const isVisible = visibleLayers.has(name);
    option.textContent = (isVisible ? '✓ ' : '') + name.replace(/_/g, ' ');
    layerSelect.appendChild(option);
  });
  
  // Reset selection to default
  layerSelect.selectedIndex = 0;
};

  layerSelect.addEventListener('change', e => {
    if (e.target.value === 'SELECT_ALL') {
      selectAllLayers();
    } else if (e.target.value === 'HIDE_ALL') {
      hideAllLayers();
    } else if (e.target.value) {
      createMountainLayer(e.target.value);
    }
  });
  
  document.getElementById('toggle-countries').addEventListener('change', e => countriesLayer.setVisible(e.target.checked));
  document.getElementById('toggle-gmba').addEventListener('change', e => gmbaLayer.setVisible(e.target.checked));
  document.getElementById('basemap-select').addEventListener('change', e => {
    osmLayer.setVisible(e.target.value==='osm');
    satelliteLayer.setVisible(e.target.value==='satellite');
  });

  // Feature click info
  map.on('singleclick', evt => {
  const infoDiv = document.getElementById('info');
  const features = [];
  map.forEachFeatureAtPixel(evt.pixel, f => features.push(f));

  if (features.length > 0) {
    const feature = features[0];
    const props = feature.getProperties();
    let html = '<div style="color:#285FA5; font-weight:bold; font-size:14px; margin-bottom:6px;">Feature Information:</div>';

    // Check if this is a countries or GMBA layer feature
    const layer = feature.ol_uid ? map.getLayers().getArray().find(l => {
      if (l.getSource && l.getSource().getFeatures) {
        return l.getSource().getFeatures().includes(feature);
      }
      return false;
    }) : null;

    const isCountriesOrGMBA = layer === countriesLayer || layer === gmbaLayer;

    if (isCountriesOrGMBA) {
      // Show only specific attributes for countries/GMBA layers
      Object.keys(props).forEach(key => {
        if (key !== 'geometry') {
          let value = props[key];

          // Make URLs clickable
          if (typeof value === 'string' && value.startsWith('https://')) {
            value = `<a href="${value}" target="_blank">${value}</a>`;
          }

          if (key === 'MapName') {
            html += `<strong>Mountain Range:</strong> ${value}<br>`;
          } else if (key === 'country') {
            html += `<strong>Country:</strong> ${value}<br>`;
          }
          // skip all other keys for countries/GMBA layers
        }
      });
    } else {
      // Show all attributes for mountain point layers
      Object.keys(props).forEach(key => {
        if (key !== 'geometry') {
          let value = props[key];

          // Make URLs clickable
          if (typeof value === 'string' && value.startsWith('https://')) {
            value = `<a href="${value}" target="_blank">${value}</a>`;
          }

          html += `<strong>${key.replace(/_/g, ' ')}:</strong> ${value}<br>`;
        }
      });
    }

    infoDiv.innerHTML = html;
  } else {
    infoDiv.innerHTML = 'Click on features to see attributes';
  }
});

});
</script>
<img id="logo" src="logo.png" alt="Logo">
</body>
</html>